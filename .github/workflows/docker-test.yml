name: Docker Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  DOCKER_IMAGE_NAME: python-remove-bg-provider

jobs:
  docker-integration-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        docker build -t ${{ env.DOCKER_IMAGE_NAME }} .

    - name: Run comprehensive Docker tests
      run: |
        # Make the test script executable
        chmod +x ./test-docker.sh
        
        # Run the automated test script
        ./test-docker.sh

    - name: Test Docker Compose
      run: |
        # Test docker compose configuration
        docker compose config
        
        # Start services
        docker compose up -d
        
        # Wait for service to be ready
        sleep 20
        
        # Test health endpoint
        curl -f http://localhost:8001/health || exit 1
        
        # Test root endpoint
        curl -f http://localhost:8001/ || exit 1
        
        # Test documentation endpoint
        curl -f http://localhost:8001/docs || exit 1
        
        # Test OpenAPI endpoint
        curl -f http://localhost:8001/openapi.json || exit 1
        
        # Create test image
        python3 -c "
        from PIL import Image
        import io
        img = Image.new('RGB', (100, 100), color='blue')
        img_bytes = io.BytesIO()
        img.save(img_bytes, format='PNG')
        with open('/tmp/test_compose.png', 'wb') as f:
            f.write(img_bytes.getvalue())
        print('Test image for compose created')
        "
        
        # Test background removal endpoint
        curl -X POST -F "file=@/tmp/test_compose.png" http://localhost:8001/bg/remove -o /tmp/result_compose.png
        
        # Verify result is a valid PNG image
        file /tmp/result_compose.png | grep -q "PNG image" || exit 1
        
        # Test advanced background removal
        curl -X POST -F "file=@/tmp/test_compose.png" -F "model=u2net" -F "alpha_matting=true" http://localhost:8001/bg/remove-advanced -o /tmp/result_advanced_compose.png
        
        # Verify advanced result
        file /tmp/result_advanced_compose.png | grep -q "PNG image" || exit 1
        
        # Cleanup
        docker compose down

    - name: Test different models
      run: |
        # Start service
        docker compose up -d
        sleep 20
        
        # Create test image
        python3 -c "
        from PIL import Image
        import io
        img = Image.new('RGB', (50, 50), color='green')
        img_bytes = io.BytesIO()
        img.save(img_bytes, format='PNG')
        with open('/tmp/test_models.png', 'wb') as f:
            f.write(img_bytes.getvalue())
        print('Test image for models created')
        "
        
        # Test different models
        models=("u2net" "u2net_human_seg" "silueta" "isnet-general-use")
        
        for model in "${models[@]}"; do
          echo "Testing model: $model"
          curl -X POST -F "file=@/tmp/test_models.png" -F "model=$model" http://localhost:8001/bg/remove-advanced -o "/tmp/result_${model}.png"
          
          # Verify result
          file "/tmp/result_${model}.png" | grep -q "PNG image" || {
            echo "Failed to process with model: $model"
            exit 1
          }
        done
        
        # Cleanup
        docker compose down

    - name: Test error handling
      run: |
        # Start service
        docker compose up -d
        sleep 20
        
        # Test with invalid file
        echo "invalid content" > /tmp/invalid.txt
        response=$(curl -s -w "%{http_code}" -X POST -F "file=@/tmp/invalid.txt" http://localhost:8001/bg/remove -o /dev/null)
        
        # Should return error status
        if [ "$response" -eq 200 ]; then
          echo "Error: Invalid file should return error status"
          exit 1
        fi
        
        # Test with no file
        response=$(curl -s -w "%{http_code}" -X POST http://localhost:8001/bg/remove -o /dev/null)
        
        # Should return error status
        if [ "$response" -eq 200 ]; then
          echo "Error: No file should return error status"
          exit 1
        fi
        
        # Cleanup
        docker compose down

    - name: Performance test
      run: |
        # Start service
        docker compose up -d
        sleep 20
        
        # Create larger test image
        python3 -c "
        from PIL import Image
        import io
        img = Image.new('RGB', (500, 500), color='red')
        img_bytes = io.BytesIO()
        img.save(img_bytes, format='PNG')
        with open('/tmp/test_large.png', 'wb') as f:
            f.write(img_bytes.getvalue())
        print('Large test image created')
        "
        
        # Measure processing time
        start_time=$(date +%s)
        curl -X POST -F "file=@/tmp/test_large.png" http://localhost:8001/bg/remove -o /tmp/result_large.png
        end_time=$(date +%s)
        
        processing_time=$((end_time - start_time))
        echo "Processing time: ${processing_time} seconds"
        
        # Verify result
        file /tmp/result_large.png | grep -q "PNG image" || exit 1
        
        # Check processing time is reasonable (less than 60 seconds)
        if [ "$processing_time" -gt 60 ]; then
          echo "Warning: Processing time is too long: ${processing_time}s"
        fi
        
        # Cleanup
        docker compose down

    - name: Cleanup
      if: always()
      run: |
        docker compose down || true
        docker system prune -f || true




